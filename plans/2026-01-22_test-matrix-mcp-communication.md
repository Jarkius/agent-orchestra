# Plan: Test Matrix Hub, Daemon, and MCP Agent Communication

**Created**: 2026-01-22
**Branch**: main
**Role**: Main Hub Host

## Context

Recent commits:
- `e6b1866` docs: Clarify MCP vs Matrix communication layers
- `9705f30` fix: Align agent paths from /tmp to ./data for persistence
- `085d905` feat: Add PIN authentication for matrix hub connections

Related files:
- `src/matrix-hub.ts` - WebSocket hub server (:8081)
- `src/matrix-daemon.ts` - Persistent connection manager
- `src/matrix-client.ts` - Client library for hub
- `src/matrix-watch.ts` - SSE streaming for messages
- `src/tests/matrix-integration.test.ts` - Existing unit tests

## Goal

Verify end-to-end communication:
1. Matrix Hub running as main host
2. Daemon connecting with PIN auth
3. MCP tools working with local agents
4. Cross-matrix messaging (if second matrix available)

## Test Plan

### Phase 1: Hub Setup (This Machine)

```bash
# 1. Start the hub (displays PIN on startup)
bun run src/matrix-hub.ts

# Expected output:
# üîê Hub PIN: XXXXXX
# Matrix Hub listening on ws://localhost:8081
```

- [ ] Hub starts without errors
- [ ] PIN displayed on console
- [ ] Health endpoint works: `curl http://localhost:8081/health`

### Phase 2: Daemon Connection

```bash
# 2. In new terminal, start daemon with PIN
bun run src/matrix-daemon.ts start --pin <PIN>

# Or use bun memory init (auto-starts both)
bun memory init
```

- [ ] Daemon connects to hub
- [ ] Token issued and stored
- [ ] Status shows connected: `bun run src/matrix-daemon.ts status`

### Phase 3: MCP Agent Communication

```bash
# 3. Spawn agents (in new terminal)
./scripts/spawn/spawn_claude_agents.sh 2

# 4. Verify agents running
tmux attach -t claude-agents-*
```

From Claude Code, test MCP tools:

```
# Check agents registered
mcp__agent-orchestrator__get_agents

# Assign a task
mcp__agent-orchestrator__assign_task(agent_id=1, task="echo 'Hello from MCP'")

# Get result
mcp__agent-orchestrator__get_task_result(task_id=<id>, agent_id=1)
```

- [ ] Agents spawn and register
- [ ] Task reaches agent via WebSocket or ./data/agent_inbox/
- [ ] Result returned via ./data/agent_outbox/
- [ ] MCP tools return correct data

### Phase 4: Matrix Messaging

```bash
# 5. Send broadcast message
bun memory message "Test broadcast from hub"

# 6. Check inbox
bun memory message --inbox

# 7. Watch live feed (in watch pane or separate terminal)
bun memory watch
```

- [ ] Broadcast sends without error
- [ ] Message appears in inbox
- [ ] Watch pane shows real-time messages

### Phase 5: Cross-Matrix (Optional - Requires Second Machine/Project)

```bash
# On Machine B:
MATRIX_HUB_URL=ws://<hub-ip>:8081 bun run src/matrix-daemon.ts start --pin <PIN>

# Send direct message
bun memory message --to <other-matrix-id> "Direct message test"
```

- [ ] Second matrix connects to hub
- [ ] Direct messages delivered
- [ ] Broadcast reaches both matrices

## Verification Commands

```bash
# Hub health
curl http://localhost:8081/health

# Connected matrices
curl http://localhost:8081/matrices

# Daemon status
bun run src/matrix-daemon.ts status

# Agent status via MCP
# Use: mcp__agent-orchestrator__get_agents

# System dashboard
# Use: mcp__agent-orchestrator__get_system_dashboard
```

## Troubleshooting

| Issue | Check |
|-------|-------|
| "Connection refused" | Is hub running? `lsof -i :8081` |
| "Invalid PIN" | Check PIN on hub console, restart daemon |
| Tasks not reaching agents | Check `./data/agent_inbox/` exists, WebSocket :8080 |
| Results not returning | Check `./data/agent_outbox/`, agent logs |

## Success Criteria

1. ‚úÖ Hub running and accepting connections
2. ‚úÖ Daemon authenticated with PIN
3. ‚úÖ MCP assign_task ‚Üí agent ‚Üí result round-trip works
4. ‚úÖ Matrix messages broadcast and received
5. ‚úÖ Watch pane shows live message feed

---
*Generated by /plan command*
